// Prisma schema for LeadMind Insight
// MySQL Database

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 사용자
model User {
  id              String           @id @default(uuid())
  nickname        String           @db.VarChar(50)
  company         String           @db.VarChar(100)
  department      String           @db.VarChar(100)
  jobRole         String           @map("job_role") @db.VarChar(50)
  email           String           @unique @db.VarChar(255)
  agreedToTerms   Boolean          @default(false) @map("agreed_to_terms")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  assessments     Assessment[]
  serviceRequests ServiceRequest[]

  @@index([createdAt])
  @@map("users")
}

// 진단 결과 (이탈 추적 포함)
model Assessment {
  id               String       @id @default(uuid())

  // 진행 상태 추적
  status           String       @default("onboarding") @db.VarChar(20) // onboarding, diagnosis, concerns, profile, team, service, completed
  lastQuestionIndex Int?        @map("last_question_index") // 진단 중단 시 마지막 문항

  // 사용자 정보 (이탈 시에도 저장 가능하도록 optional)
  nickname         String?      @db.VarChar(50)
  company          String?      @db.VarChar(100)
  department       String?      @db.VarChar(100)
  jobRole          String?      @map("job_role") @db.VarChar(50)
  email            String?      @db.VarChar(255)
  agreedToTerms    Boolean      @default(false) @map("agreed_to_terms")

  // 진단 결과
  answers          Json?        // Record<number, number>
  scoreGrowth      Float?       @map("score_growth")
  scoreSharing     Float?       @map("score_sharing")
  scoreInteraction Float?       @map("score_interaction")
  leadershipType   String?      @map("leadership_type") @db.VarChar(10)
  selectedConcerns Json?        @map("selected_concerns") // string[]

  // 팀원 정보 (JSON으로 저장)
  teamMembersData  Json?        @map("team_members_data") // [{name, type}]

  // 케어 서비스 선택
  selectedServices Json?        @map("selected_services") // string[]

  // 유입 경로
  utmSource        String?      @map("utm_source") @db.VarChar(100)
  utmMedium        String?      @map("utm_medium") @db.VarChar(100)
  utmCampaign      String?      @map("utm_campaign") @db.VarChar(100)

  // 시간 정보
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // 기존 관계 (optional로 변경)
  userId           String?      @map("user_id")
  user             User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  teamMembers      TeamMember[]

  @@index([status])
  @@index([email])
  @@index([createdAt])
  @@index([leadershipType])
  @@map("assessments")
}

// 팀원 (팔로워십 진단)
model TeamMember {
  id              String     @id @default(uuid())
  assessmentId    String     @map("assessment_id")
  name            String     @db.VarChar(50)
  followershipType String    @map("followership_type") @db.VarChar(10)
  createdAt       DateTime   @default(now()) @map("created_at")

  assessment      Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@map("team_members")
}

// 서비스 요청
model ServiceRequest {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  requestedServices Json     @map("requested_services") // ServiceType[]
  status            String   @default("pending") @db.VarChar(20)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("service_requests")
}

// 리더십 유형 (관리자용 - CMS)
model LeadershipType {
  id          String   @id @default(uuid())
  code        String   @unique @db.VarChar(10) // L01, L02, ...
  name        String   @db.VarChar(100)
  title       String   @db.VarChar(200)
  description String   @db.Text
  strengths   Json     // string[]
  challenges  Json     // string[]
  image       String?  @db.VarChar(500)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("leadership_types")
}

// 팔로워십 유형 (관리자용 - CMS)
model FollowershipType {
  id          String   @id @default(uuid())
  code        String   @unique @db.VarChar(10) // F01, F02, ...
  name        String   @db.VarChar(100) // Driver, Thinker, etc.
  title       String   @db.VarChar(200)
  description String   @db.Text
  icon        String?  @db.VarChar(50)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("followership_types")
}

// 궁합 데이터 (관리자용 - CMS)
model Compatibility {
  id           String   @id @default(uuid())
  leaderType   String   @map("leader_type") @db.VarChar(10)
  followerType String   @map("follower_type") @db.VarChar(10)
  strengths    Json     // string[]
  cautions     Json     // string[]
  tips         Json     // string[]
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([leaderType, followerType])
  @@index([leaderType])
  @@index([followerType])
  @@map("compatibilities")
}

// 설문 문항 (관리자용 - CMS)
model Question {
  id          String   @id @default(uuid())
  code        String   @unique @db.VarChar(10) // Q01, Q02, ...
  text        String   @db.Text
  category    String   @db.VarChar(20) // growth, sharing, interaction
  subcategory String?  @db.VarChar(50)
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([isActive, sortOrder])
  @@index([category])
  @@map("questions")
}

// 고민 키워드 (관리자용 - CMS)
model Concern {
  id         String   @id @default(uuid())
  code       String   @unique @db.VarChar(10) // C01, C02, ...
  label      String   @db.VarChar(200)
  categories Json     // string[] - E, G, C, L
  groupName  String   @map("group_name") @db.VarChar(100)
  sortOrder  Int      @default(0) @map("sort_order")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([isActive, sortOrder])
  @@index([groupName])
  @@map("concerns")
}

// 솔루션 (관리자용 - CMS)
model Solution {
  id          String           @id @default(uuid())
  code        String           @unique @db.VarChar(10) // P01, P02, ...
  combination String           @db.VarChar(10) // L+E, G+C, etc.
  title       String           @db.VarChar(500)
  coreIssue   String           @map("core_issue") @db.Text
  fieldVoices Json             @map("field_voices") // string[]
  diagnosis   String           @db.Text
  sortOrder   Int              @default(0) @map("sort_order")
  isActive    Boolean          @default(true) @map("is_active")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  actions     SolutionAction[]

  @@index([isActive, sortOrder])
  @@index([combination])
  @@map("solutions")
}

// 솔루션 액션 (관리자용 - CMS)
model SolutionAction {
  id            String   @id @default(uuid())
  solutionId    String   @map("solution_id")
  title         String   @db.VarChar(200)
  method        String   @db.Text
  effect        String   @db.Text
  leadershipTip String   @map("leadership_tip") @db.Text
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  solution      Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  @@index([solutionId, sortOrder])
  @@map("solution_actions")
}
